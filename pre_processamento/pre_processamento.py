from datetime import datetime, timedelta
from sqlalchemy import create_engine
import pandas as pd
import pymysql
from pyspark.sql import SparkSession
from pyspark.sql.types import StringType, StructField, StructType
import numpy as np


class PreprocessDataset:
    def __init__(self, df):
        self.df = df
    
    import pandas as pd

    def converter_tipos_colunas(self, df):
        """
        Converte automaticamente as colunas do DataFrame para os tipos apropriados:

        - Se o nome da coluna contiver "DT", converte para DATETIME.
        - Se todos os valores forem num√©ricos, converte para INT.
        - Caso contr√°rio, converte para STRING.

        Par√¢metros:
        - df (pd.DataFrame): O DataFrame a ser processado.

        Retorna:
        - pd.DataFrame: O DataFrame atualizado com os tipos de colunas convertidos.
        """

        try:
            # üöÄ Criar uma c√≥pia do DataFrame para evitar modificar o original
            df = df.copy()

            print("üîÑ Iniciando convers√£o autom√°tica de tipos...\n")

            for col in df.columns:
                # Remover valores nulos temporariamente
                valores_validos = df[col].dropna()

                if valores_validos.empty:
                    print(f"‚ö†Ô∏è Coluna '{col}' vazia. Mantendo como est√°.")
                    continue

                # üöÄ Se o nome da coluna cont√©m 'DT', for√ßar convers√£o para DATETIME
                if "DT" in col.upper():
                    df[col] = pd.to_datetime(df[col], errors="coerce", dayfirst=True)
                    print(f"üìÖ Coluna '{col}' convertida para DATETIME.")

                # üöÄ Se todos os valores s√£o num√©ricos, converter para INT
                elif pd.to_numeric(valores_validos, errors="coerce").notna().all():
                    df[col] = pd.to_numeric(df[col], errors="coerce").fillna(0).astype(int)
                    print(f"‚úÖ Coluna '{col}' convertida para INT.")

                # üöÄ Caso contr√°rio, converter para STRING
                else:
                    df[col] = df[col].astype(str)
                    print(f"üî§ Coluna '{col}' convertida para STRING.")

            print("\n‚úÖ Convers√£o de tipos conclu√≠da!")
            print(df.info())
            return df

        except Exception as e:
            print(f"‚ùå Erro ao converter tipos: {str(e)}")
            return df




        





